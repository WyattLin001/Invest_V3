# LINE 風格聊天功能使用指南

## 📱 功能概述

本應用已成功實現 LINE 風格的群組聊天功能，支援：
- 根據用戶角色（主持人/成員）顯示不同顏色的訊息泡泡
- 即時聊天功能
- 深色模式支援
- 自動群組成員管理

## 🎨 UI 設計特點

### 訊息泡泡顏色
- **主持人訊息**：藍色泡泡 (Color.blue)
- **成員訊息**：綠色泡泡 (Color.green)
- **投資指令**：特殊標記和圖示

### 深色模式支援
- **淺色模式**：背景 #FFFFFF，文字 #000000
- **深色模式**：背景 #121212，文字 #E0E0E0

### 訊息泡泡樣式
- 圓角：8px
- 最大寬度：80% 螢幕寬度
- 自適應內容高度
- 包含發送者名稱、時間戳記和角色標示

## 🔧 測試用戶設定

### 測試用戶
1. **主持人用戶**
   - Email: `f227006900@gmail.com`
   - 顯示名稱：「主持人」
   - 角色：host
   - 泡泡顏色：藍色

2. **成員用戶**
   - Email: `yuka@gmail.com`
   - 顯示名稱：「成員」
   - 角色：member
   - 泡泡顏色：綠色

### 測試群組
- **群組名稱**：價值投資學院
- **群組ID**：`123e4567-e89b-12d3-a456-426614174000`
- **主持人**：主持人
- **成員數**：2 人（主持人 + 成員）

## 🚀 使用方法

### 1. 設置測試環境
```swift
// 在 Debug Panel 中點擊「🏗️ 設置測試環境」按鈕
// 或在代碼中調用：
await SupabaseService.shared.createTestEnvironment()
await SupabaseService.shared.createTestUsers()
```

### 2. 用戶切換測試
```swift
// 切換到主持人
await SupabaseService.shared.simulateUserSwitch(toEmail: "f227006900@gmail.com")

// 切換到成員
await SupabaseService.shared.simulateUserSwitch(toEmail: "yuka@gmail.com")
```

### 3. 發送測試訊息
```swift
// 主持人發送歡迎訊息
await SupabaseService.shared.simulateTestMessage(
    fromEmail: "f227006900@gmail.com",
    groupId: TestConstants.testGroupId,
    content: "歡迎加入群組"
)

// 成員發送感謝訊息
await SupabaseService.shared.simulateTestMessage(
    fromEmail: "yuka@gmail.com",
    groupId: TestConstants.testGroupId,
    content: "謝謝主持人"
)
```

## 🧪 Debug Panel 功能

### 診斷功能
- **🔍 執行診斷檢查**：檢查資料庫連線狀態
- **🧪 執行修復測試**：執行基本的聊天功能測試
- **💬 LINE 聊天測試**：完整的 LINE 風格聊天功能測試

### 測試功能
- **🏗️ 設置測試環境**：創建測試群組和用戶
- **🏠 模擬加入測試群組**：將當前用戶加入測試群組
- **💬 發送測試訊息**：發送基本測試訊息
- **📋 檢查測試群組訊息**：查看測試群組的所有訊息

### 用戶切換測試
- **👑 切換到主持人**：切換到主持人用戶
- **👤 切換到成員**：切換到成員用戶
- **💬 主持人發送歡迎訊息**：模擬主持人發送歡迎訊息
- **💬 成員發送感謝訊息**：模擬成員發送感謝訊息

## 📊 資料庫結構

### 相關表格
1. **user_profiles**：用戶資料
2. **investment_groups**：投資群組
3. **chat_messages**：聊天訊息
4. **group_members**：群組成員關係

### 權限控制
- 使用 RLS (Row Level Security) 確保資料安全
- 自動檢查群組成員資格
- 發送訊息前自動加入群組

## 🔍 測試驗證

### 測試項目
1. **用戶角色識別**：驗證主持人和成員角色正確識別
2. **訊息泡泡顏色**：驗證不同角色顯示不同顏色
3. **即時聊天功能**：驗證訊息正確儲存和獲取
4. **群組成員數計算**：驗證實際成員數計算正確
5. **資料庫連線**：驗證資料庫連線和基本功能

### 測試步驟
1. 打開 Debug Panel
2. 點擊「💬 LINE 聊天測試」按鈕
3. 觀察控制台輸出，確認所有測試通過
4. 在聊天介面中驗證訊息泡泡顏色
5. 測試用戶切換功能

## 🎯 預期結果

### 主持人訊息
- 顯示藍色泡泡
- 包含皇冠圖示 👑
- 發送者名稱顯示為藍色
- 右側對齊（如果是自己的訊息）

### 成員訊息
- 顯示綠色泡泡
- 無特殊圖示
- 發送者名稱顯示為綠色
- 左側對齊（如果是他人的訊息）

### 群組資訊
- 頂部導航欄顯示實際成員數
- 群組名稱：價值投資學院
- 主持人：主持人

## 🔧 故障排除

### 常見問題
1. **訊息發送失敗**
   - 檢查資料庫連線
   - 確認用戶已加入群組
   - 檢查 RLS 政策

2. **角色識別錯誤**
   - 確認測試環境已正確設置
   - 檢查用戶資料是否正確
   - 驗證群組主持人設定

3. **訊息泡泡顏色錯誤**
   - 確認 userRole 屬性正確設置
   - 檢查 ChatBubbleView 的顏色邏輯
   - 驗證深色模式設定

### 重置方法
如果遇到問題，可以：
1. 點擊「🔄 完整重置並重新同步」
2. 重新設置測試環境
3. 清除 UserDefaults
4. 重新啟動應用

## 📱 實際使用

在實際使用中：
1. 用戶進入群組後會自動成為成員
2. 主持人由群組創建者決定
3. 訊息會根據發送者角色自動顯示正確顏色
4. 支援即時訊息更新（目前使用定時器，每3秒更新一次）

## 🔮 未來擴展

可以考慮的功能擴展：
1. WebSocket 即時通訊
2. 訊息已讀狀態
3. 訊息回覆功能
4. 表情符號反應
5. 檔案分享功能 