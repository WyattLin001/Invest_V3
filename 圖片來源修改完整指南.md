# ğŸ“¸ Invest_V3 åœ–ç‰‡ä¾†æºä¿®æ”¹å®Œæ•´æŒ‡å—

## ğŸ¯ ç›®å‰çš„åœ–ç‰‡ä¾†æºç³»çµ±

### 1. **ç”¨æˆ¶é ­åƒç³»çµ±**
**ä½ç½®**: `SettingsView.swift` + `SettingsViewModel.swift`
- **ç•¶å‰ä¾†æº**: æ‰‹æ©Ÿç›¸ç‰‡åº« (PhotosPicker)
- **è™•ç†**: è‡ªå‹•è£åˆ‡ç‚º 512x512 åœ“å½¢é ­åƒ
- **å­˜å„²**: âœ… å·²å¯¦ç¾é›²ç«¯ä¸Šå‚³åˆ° Supabase Storage
- **é…ç½®**: `.photosPicker(isPresented: $showImagePicker, selection: $selectedPhotoItem, matching: .images)`

### 2. **æ–‡ç« å…§å®¹åœ–ç‰‡**
**ä½ç½®**: `MediumStyleEditor.swift`
- **ç•¶å‰ä¾†æº**: æ‰‹æ©Ÿç›¸ç‰‡åº« (PhotosPicker)
- **è™•ç†**: æ”¯æ´å¤šç¨®æ ¼å¼ (JPG, PNG, GIF, WebP, TIFF, BMP, HEIC)
- **å­˜å„²**: âœ… å·²å¯¦ç¾ä¸Šå‚³åˆ° Supabase Storage
- **é…ç½®**: `.photosPicker(isPresented: $showPhotoPicker, selection: $selectedPhotosPickerItems, maxSelectionCount: 1, matching: .any(of: [.images, .not(.videos)]))`

### 3. **ç¾¤çµ„é ­åƒ**
**ä½ç½®**: `CreateGroupView.swift` + `GroupAvatarPicker.swift`
- **ç•¶å‰ä¾†æº**: æ‰‹æ©Ÿç›¸ç‰‡åº« (PhotosPicker)
- **è™•ç†**: åŸºæœ¬åœ–ç‰‡é¸æ“‡
- **å­˜å„²**: âš ï¸ ç›®å‰åƒ…æœ¬åœ°å­˜å„²

## ğŸ”§ ä¿®æ”¹åœ–ç‰‡ä¾†æºçš„æ–¹æ³•

### **æ–¹æ³•1: é™åˆ¶åœ–ç‰‡ä¾†æº**

#### A. åªå…è¨±æ‹ç…§ (ä¸å…è¨±ç›¸ç‰‡åº«)
```swift
// åœ¨ SettingsView.swift ä¸­æ›¿æ›ç¾æœ‰çš„ PhotosPicker
import UIKit

struct CameraOnlyPicker: UIViewControllerRepresentable {
    @Binding var selectedImage: UIImage?
    @Environment(\.presentationMode) var presentationMode
    
    func makeUIViewController(context: Context) -> UIImagePickerController {
        let picker = UIImagePickerController()
        picker.delegate = context.coordinator
        picker.sourceType = .camera  // å¼·åˆ¶ä½¿ç”¨ç›¸æ©Ÿ
        picker.allowsEditing = true
        return picker
    }
    
    // ... å…¶ä»–å¯¦ç¾
}

// ä½¿ç”¨æ–¹å¼:
.sheet(isPresented: $showImagePicker) {
    CameraOnlyPicker(selectedImage: $capturedImage)
}
```

#### B. é™åˆ¶åœ–ç‰‡æ ¼å¼
```swift
// ä¿®æ”¹ç¾æœ‰çš„ PhotosPicker é…ç½®
.photosPicker(
    isPresented: $showImagePicker,
    selection: $selectedPhotoItem,
    matching: .any(of: [
        .images,
        .not(.screenshots),  // æ’é™¤æˆªåœ–
        .not(.livePhotos)    // æ’é™¤ Live Photos
    ])
)
```

#### C. é™åˆ¶åœ–ç‰‡å¤§å°
```swift
// åœ¨ SettingsViewModel.swift ä¸­æ·»åŠ å¤§å°æª¢æŸ¥
func loadAndProcessImage(from item: PhotosPickerItem) async {
    do {
        guard let data = try await item.loadTransferable(type: Data.self),
              let image = UIImage(data: data) else {
            errorMessage = "ç„¡æ³•è¼‰å…¥é¸å–çš„åœ–ç‰‡"
            return
        }
        
        // æª¢æŸ¥æ–‡ä»¶å¤§å° (ä¾‹å¦‚é™åˆ¶ 5MB)
        let maxSizeInBytes = 5 * 1024 * 1024 // 5MB
        if data.count > maxSizeInBytes {
            errorMessage = "åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 5MB çš„åœ–ç‰‡"
            return
        }
        
        // æª¢æŸ¥åœ–ç‰‡å°ºå¯¸
        let maxDimension: CGFloat = 2048
        if image.size.width > maxDimension || image.size.height > maxDimension {
            errorMessage = "åœ–ç‰‡å°ºå¯¸éå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 2048x2048 çš„åœ–ç‰‡"
            return
        }
        
        // ç¹¼çºŒè™•ç†...
    }
}
```

### **æ–¹æ³•2: æ·»åŠ ç¶²è·¯åœ–ç‰‡ä¾†æº**

#### A. URL è¼¸å…¥æ–¹å¼
```swift
// æ·»åŠ åˆ° SettingsView.swift
struct NetworkImagePicker: View {
    @State private var imageURL: String = ""
    @Binding var selectedImage: UIImage?
    @State private var isLoading = false
    
    var body: some View {
        VStack(spacing: 16) {
            TextField("è¼¸å…¥åœ–ç‰‡ç¶²å€ (https://...)", text: $imageURL)
                .textFieldStyle(.roundedBorder)
                .keyboardType(.URL)
                .autocapitalization(.none)
            
            Button("è¼‰å…¥åœ–ç‰‡") {
                loadImageFromURL()
            }
            .disabled(imageURL.isEmpty || isLoading)
            
            if isLoading {
                ProgressView("è¼‰å…¥ä¸­...")
            }
        }
    }
    
    private func loadImageFromURL() {
        guard let url = URL(string: imageURL),
              url.scheme?.hasPrefix("http") == true else {
            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            return
        }
        
        isLoading = true
        
        URLSession.shared.dataTask(with: url) { data, response, error in
            DispatchQueue.main.async {
                self.isLoading = false
                
                guard let data = data,
                      let image = UIImage(data: data) else {
                    // é¡¯ç¤ºè¼‰å…¥å¤±æ•—è¨Šæ¯
                    return
                }
                
                self.selectedImage = image
                self.imageURL = ""
            }
        }.resume()
    }
}
```

### **æ–¹æ³•3: æ·»åŠ é è¨­é ­åƒç³»çµ±**

#### A. SF Symbols é è¨­é ­åƒ
```swift
// æ·»åŠ åˆ° SettingsView.swift
struct DefaultAvatarPicker: View {
    let defaultAvatars = [
        "person.crop.circle.fill",
        "person.crop.circle.badge.plus",
        "person.crop.circle.badge.checkmark",
        "person.2.crop.circle.stack.fill",
        "graduationcap.circle.fill",
        "briefcase.circle.fill",
        "chart.line.uptrend.xyaxis.circle.fill",
        "dollarsign.circle.fill"
    ]
    
    @Binding var selectedAvatarIcon: String?
    let avatarSize: CGFloat = 60
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("é¸æ“‡é è¨­é ­åƒ")
                .font(.headline)
            
            LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 4), spacing: 12) {
                ForEach(defaultAvatars, id: \.self) { avatar in
                    Button(action: {
                        selectedAvatarIcon = avatar
                    }) {
                        Image(systemName: avatar)
                            .font(.system(size: 30))
                            .foregroundColor(selectedAvatarIcon == avatar ? .white : .investGreen)
                            .frame(width: avatarSize, height: avatarSize)
                            .background(
                                Circle()
                                    .fill(selectedAvatarIcon == avatar ? Color.investGreen : Color.gray.opacity(0.1))
                            )
                            .overlay(
                                Circle()
                                    .stroke(Color.investGreen, lineWidth: selectedAvatarIcon == avatar ? 2 : 1)
                            )
                    }
                }
            }
        }
    }
}
```

#### B. é¡è‰²é ­åƒç”Ÿæˆå™¨
```swift
// åŸºæ–¼ç”¨æˆ¶åç¨±ç”Ÿæˆé ­åƒ
struct InitialsAvatarGenerator {
    static func generateAvatar(name: String, size: CGSize = CGSize(width: 512, height: 512)) -> UIImage {
        let initials = String(name.prefix(2)).uppercased()
        let colors: [UIColor] = [.systemBlue, .systemGreen, .systemOrange, .systemPurple, .systemRed, .systemYellow]
        let backgroundColor = colors[abs(name.hashValue) % colors.count]
        
        let renderer = UIGraphicsImageRenderer(size: size)
        return renderer.image { context in
            // å¡«å……èƒŒæ™¯
            backgroundColor.setFill()
            context.fill(CGRect(origin: .zero, size: size))
            
            // ç¹ªè£½æ–‡å­—
            let font = UIFont.systemFont(ofSize: size.width * 0.4, weight: .medium)
            let attributes: [NSAttributedString.Key: Any] = [
                .font: font,
                .foregroundColor: UIColor.white
            ]
            
            let textSize = initials.size(withAttributes: attributes)
            let textRect = CGRect(
                x: (size.width - textSize.width) / 2,
                y: (size.height - textSize.height) / 2,
                width: textSize.width,
                height: textSize.height
            )
            
            initials.draw(in: textRect, withAttributes: attributes)
        }
    }
}
```

### **æ–¹æ³•4: åœ–ç‰‡ä¾†æºé¸æ“‡å™¨**

#### A. å¤šé¸é …åœ–ç‰‡ä¾†æº
```swift
// æ·»åŠ åˆ° SettingsView.swift
struct ImageSourcePicker: View {
    @Binding var selectedImage: UIImage?
    @State private var showActionSheet = false
    @State private var showCamera = false
    @State private var showPhotoLibrary = false
    @State private var showNetworkPicker = false
    @State private var showDefaultAvatars = false
    
    var body: some View {
        Button("é¸æ“‡é ­åƒ") {
            showActionSheet = true
        }
        .confirmationDialog("é¸æ“‡åœ–ç‰‡ä¾†æº", isPresented: $showActionSheet) {
            Button("æ‹ç…§") { showCamera = true }
            Button("å¾ç›¸ç‰‡åº«é¸æ“‡") { showPhotoLibrary = true }
            Button("å¾ç¶²è·¯è¼‰å…¥") { showNetworkPicker = true }
            Button("ä½¿ç”¨é è¨­é ­åƒ") { showDefaultAvatars = true }
            Button("å–æ¶ˆ", role: .cancel) { }
        }
        .sheet(isPresented: $showCamera) {
            CameraOnlyPicker(selectedImage: $selectedImage)
        }
        .sheet(isPresented: $showPhotoLibrary) {
            PhotoLibraryPicker(selectedImage: $selectedImage)
        }
        .sheet(isPresented: $showNetworkPicker) {
            NetworkImagePicker(selectedImage: $selectedImage)
        }
        .sheet(isPresented: $showDefaultAvatars) {
            DefaultAvatarPicker(selectedAvatarIcon: .constant(nil))
        }
    }
}
```

## ğŸš€ å¯¦æ–½å»ºè­°

### **ç«‹å³å¯ç”¨çš„ä¿®æ”¹**
1. **é™åˆ¶åœ–ç‰‡æ ¼å¼**: ä¿®æ”¹ PhotosPicker çš„ `matching` åƒæ•¸
2. **æ·»åŠ å¤§å°æª¢æŸ¥**: åœ¨åœ–ç‰‡è™•ç†å‡½æ•¸ä¸­æ·»åŠ é©—è­‰
3. **å•Ÿç”¨é è¨­é ­åƒ**: å¯¦ç¾ SF Symbols é ­åƒé¸æ“‡å™¨

### **éœ€è¦å¾Œç«¯é…ç½®çš„åŠŸèƒ½**
1. **é›²ç«¯å­˜å„²**: âœ… å·²å¯¦ç¾ï¼Œéœ€è¦åœ¨ Supabase ä¸­å‰µå»º `avatars` bucket
2. **ç¶²è·¯åœ–ç‰‡**: å¯¦ç¾ URL åœ–ç‰‡è¼‰å…¥åŠŸèƒ½
3. **åœ–ç‰‡å£“ç¸®**: æ·»åŠ ä¼ºæœå™¨ç«¯åœ–ç‰‡å„ªåŒ–

### **Supabase Storage è¨­å®š**

åœ¨ Supabase Dashboard ä¸­å‰µå»ºä»¥ä¸‹ buckets:
```sql
-- å‰µå»ºé ­åƒå­˜å„²æ¡¶
INSERT INTO storage.buckets (id, name, public)
VALUES ('avatars', 'avatars', true);

-- è¨­å®šå…¬é–‹å­˜å–æ”¿ç­–
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'avatars');
CREATE POLICY "Authenticated Upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'avatars' AND auth.role() = 'authenticated');
```

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

- âœ… ç”¨æˆ¶é ­åƒä¸Šå‚³åˆ° Supabase Storage
- âœ… æ–‡ç« åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½
- âœ… åœ–ç‰‡æ ¼å¼é©—è­‰
- âš ï¸ ç¾¤çµ„é ­åƒé›²ç«¯å­˜å„² (å¾…å¯¦ç¾)
- âš ï¸ é è¨­é ­åƒç³»çµ± (å¯é¸)
- âš ï¸ ç¶²è·¯åœ–ç‰‡è¼‰å…¥ (å¯é¸)
- âš ï¸ åœ–ç‰‡ä¾†æºé¸æ“‡å™¨ (å¯é¸)

## ğŸ”§ å¿«é€Ÿä¿®æ”¹æ­¥é©Ÿ

1. **å‚™ä»½ç¾æœ‰ä»£ç¢¼**
2. **é¸æ“‡éœ€è¦çš„ä¿®æ”¹æ–¹å¼** (ä¸Šè¿°æ–¹æ³• 1-4)
3. **æ›´æ–°ç›¸é—œçš„ View å’Œ ViewModel**
4. **é…ç½® Supabase Storage** (å¦‚éœ€é›²ç«¯å­˜å„²)
5. **æ¸¬è©¦å„ç¨®åœ–ç‰‡ä¾†æº**
6. **éƒ¨ç½²æ›´æ–°**

é€™å€‹æŒ‡å—æä¾›äº†å®Œæ•´çš„åœ–ç‰‡ä¾†æºä¿®æ”¹æ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥æ ¹æ“šéœ€æ±‚é¸æ“‡åˆé©çš„å¯¦ç¾æ–¹å¼ï¼