# 收益資格達成判斷系統 - 完整文檔

## 📋 系統概述

**收益資格達成判斷系統**是一個綜合性的作者收益管理平台，旨在通過四項核心條件來評估和追蹤作者是否符合收益分潤資格。

### 🎯 核心目標
- 確保高品質內容創作
- 建立公平的收益分配機制
- 提供透明的資格評估流程
- 激勵作者持續創作優質內容

## 🔄 系統架構

### 核心組件
1. **數據模型層** - 定義資格狀態和閱讀記錄
2. **服務層** - 處理追蹤、評估和通知邏輯
3. **UI層** - 提供用戶界面和進度顯示
4. **數據庫層** - 存儲和查詢相關數據

### 技術棧
- **前端**: SwiftUI + MVVM架構
- **後端**: Supabase PostgreSQL + RPC函數
- **實時追蹤**: Timer + NotificationCenter
- **通知系統**: UserNotifications + 本地推送

## 📊 四項資格條件

### 1. 📝 過去90天文章發表 
**要求**: 至少發表1篇公開文章
- **檢查週期**: 每日評估
- **數據來源**: `articles` 表中 `status = 'published'` 且 `created_at >= 90天前`
- **圖標**: `doc.text.fill`

### 2. 👥 過去30天獨立讀者數
**要求**: 至少100位獨立讀者閱讀作者文章
- **檢查週期**: 每日評估
- **數據來源**: `article_read_logs` 表統計唯一 `user_id`
- **圖標**: `person.3.fill`

### 3. 🛡️ 無違規記錄
**要求**: 無重大違規或檢舉記錄
- **檢查週期**: 即時檢查
- **數據來源**: 違規記錄表（未來實現）
- **圖標**: `checkmark.shield.fill`

### 4. 💳 錢包設置完成
**要求**: 完成平台錢包設置
- **檢查週期**: 即時檢查
- **數據來源**: `wallets` 表中是否存在用戶記錄
- **圖標**: `wallet.pass.fill`

## 🗄️ 數據模型

### ArticleReadLog - 閱讀記錄
```swift
struct ArticleReadLog {
    let id: UUID                    // 記錄ID
    let articleId: UUID            // 文章ID
    let userId: UUID               // 讀者ID
    let readStartTime: Date        // 開始閱讀時間
    let readEndTime: Date?         // 結束閱讀時間
    let readDurationSeconds: Int   // 閱讀時長(秒)
    let scrollPercentage: Double   // 滾動百分比(0-100)
    let isCompleteRead: Bool       // 是否完整閱讀(>80%)
    let deviceType: String         // 設備類型("iOS")
    let createdAt: Date           // 創建時間
}
```

### AuthorEligibilityStatus - 作者資格狀態
```swift
struct AuthorEligibilityStatus {
    let id: UUID                        // 狀態ID
    let authorId: UUID                  // 作者ID
    let isEligible: Bool               // 是否符合資格
    let last90DaysArticles: Int        // 90天內文章數
    let last30DaysUniqueReaders: Int   // 30天內獨立讀者數
    let hasViolations: Bool            // 是否有違規
    let hasWalletSetup: Bool          // 是否完成錢包設置
    let eligibilityScore: Double       // 資格分數(0-100)
    let lastEvaluatedAt: Date         // 最後評估時間
    let nextEvaluationAt: Date        // 下次評估時間
    let notifications: [EligibilityNotification] // 通知列表
    let createdAt: Date              // 創建時間
    let updatedAt: Date              // 更新時間
}
```

### EligibilityProgress - 進度追蹤
```swift
struct EligibilityProgress {
    let condition: EligibilityCondition  // 條件類型
    let isCompleted: Bool               // 是否完成
    let currentValue: Int               // 當前值
    let requiredValue: Int              // 所需值
    let progressPercentage: Double      // 進度百分比
}
```

## 🔧 核心服務

### 1. ReadingTrackingService - 閱讀追蹤服務

**功能**: 實時追蹤用戶閱讀行為
```swift
// 開始追蹤
func startReading(article: Article)

// 更新進度
func updateReadingProgress(scrollPercentage: Double)

// 結束追蹤
func endReading(scrollPercentage: Double = 0)

// 保存記錄
private func saveReadingLog(session: ReadingSession)
```

**追蹤數據**:
- 閱讀開始時間
- 閱讀結束時間
- 閱讀總時長
- 滾動進度百分比
- 是否完整閱讀(>80%滾動)

### 2. EligibilityEvaluationService - 資格評估引擎

**功能**: 評估作者收益資格
```swift
// 評估單個作者
func evaluateAuthor(_ authorId: UUID) -> EligibilityEvaluationResult?

// 每日批量評估
func performDailyEvaluation()

// 獲取資格狀態
func getAuthorEligibilityStatus(_ authorId: UUID) -> AuthorEligibilityStatus?
```

**評估邏輯**:
1. 查詢作者閱讀分析數據
2. 檢查錢包設置狀態
3. 檢查違規記錄
4. 計算綜合資格分數
5. 生成相關通知
6. 保存評估結果

### 3. EligibilityNotificationService - 通知服務

**功能**: 管理資格相關通知
```swift
// 資格達成通知
func sendEligibilityAchievedNotification()

// 接近門檻通知
func sendNearThresholdNotification(condition:currentValue:requiredValue:)

// 資格失效通知
func sendEligibilityLostNotification()

// 每日提醒設置
func scheduleDaily條件檢查Reminder()
```

**通知類型**:
- 🎉 資格達成 (qualified)
- ⚠️ 資格失效 (disqualified)
- ⚡ 接近門檻 (near_threshold)
- 💡 警告提醒 (warning)

## 🎨 用戶界面

### AuthorEarningsView - 收益頁面增強

**新增功能**:
- 資格進度追蹤卡片
- 實時條件完成狀態
- 進度條和百分比顯示
- 建議行動提示

**UI組件**:
```swift
// 資格進度卡片
private var eligibilityProgressCard: some View

// 進度行組件
private func eligibilityProgressRow(_ progress: EligibilityProgress) -> some View

// 資格狀態指示器
HStack(spacing: 6) {
    Image(systemName: status.isEligible ? "checkmark.circle.fill" : "clock.circle.fill")
    Text(status.isEligible ? "已達成" : "進行中")
}
```

### ArticleDetailView - 閱讀追蹤整合

**整合功能**:
- 自動開始閱讀追蹤
- 自動結束追蹤並保存
- 滾動進度監控(未來版本)

**生命週期**:
```swift
.onAppear {
    readingTracker.startReading(article: article)
}
.onDisappear {
    readingTracker.endReading(scrollPercentage: 50.0)
}
```

## ⏱️ 定時評估機制

### 每日評估流程
1. **觸發時間**: 每天凌晨2:00
2. **評估範圍**: 所有有文章的作者
3. **評估步驟**:
   - 獲取作者列表
   - 逐一評估每個作者
   - 更新資格狀態
   - 發送相關通知
   - 記錄評估結果

### 評估算法
```swift
// 條件檢查
let conditions = [
    .articles90Days: analytics.last90DaysArticles >= 1,
    .uniqueReaders30Days: analytics.last30DaysUniqueReaders >= 100,
    .noViolations: !hasViolations,
    .walletSetup: hasWalletSetup
]

// 分數計算
let eligibilityScore = (completedConditions / totalConditions) * 100.0

// 資格判定
let isEligible = conditions.values.allSatisfy { $0 }
```

## 📊 數據庫設計

### 新增表結構

#### article_read_logs - 閱讀記錄表
```sql
CREATE TABLE article_read_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    article_id UUID REFERENCES articles(id),
    user_id UUID REFERENCES users(id),
    read_start_time TIMESTAMP WITH TIME ZONE,
    read_end_time TIMESTAMP WITH TIME ZONE,
    read_duration_seconds INTEGER,
    scroll_percentage DOUBLE PRECISION,
    is_complete_read BOOLEAN,
    device_type TEXT DEFAULT 'iOS',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### author_eligibility_status - 作者資格狀態表
```sql
CREATE TABLE author_eligibility_status (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    author_id UUID REFERENCES users(id),
    is_eligible BOOLEAN,
    last_90_days_articles INTEGER,
    last_30_days_unique_readers INTEGER,
    has_violations BOOLEAN,
    has_wallet_setup BOOLEAN,
    eligibility_score DOUBLE PRECISION,
    last_evaluated_at TIMESTAMP WITH TIME ZONE,
    next_evaluation_at TIMESTAMP WITH TIME ZONE,
    notifications JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 必要的RPC函數

#### get_article_reading_stats - 文章閱讀統計
```sql
CREATE OR REPLACE FUNCTION get_article_reading_stats(article_id UUID)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'total_reads', COUNT(*),
        'unique_readers', COUNT(DISTINCT user_id),
        'average_read_time', AVG(read_duration_seconds),
        'completion_rate', AVG(CASE WHEN is_complete_read THEN 1.0 ELSE 0.0 END),
        'last_30_days_reads', COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '30 days'),
        'last_7_days_reads', COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days')
    ) INTO result
    FROM article_read_logs 
    WHERE article_id = $1;
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

#### get_author_reading_analytics - 作者閱讀分析
```sql
CREATE OR REPLACE FUNCTION get_author_reading_analytics(author_id UUID)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    WITH author_articles AS (
        SELECT id FROM articles WHERE author_id = $1 AND status = 'published'
    ),
    reading_stats AS (
        SELECT 
            COUNT(*) as total_reads,
            COUNT(DISTINCT arl.user_id) as unique_readers,
            COUNT(DISTINCT arl.user_id) FILTER (WHERE arl.created_at >= NOW() - INTERVAL '30 days') as last_30_days_unique_readers,
            COUNT(DISTINCT a.id) FILTER (WHERE a.created_at >= NOW() - INTERVAL '90 days') as last_90_days_articles,
            AVG(arl.read_duration_seconds) as average_read_time,
            AVG(CASE WHEN arl.is_complete_read THEN 1.0 ELSE 0.0 END) as completion_rate
        FROM author_articles a
        LEFT JOIN article_read_logs arl ON a.id = arl.article_id
        LEFT JOIN articles art ON a.id = art.id
    )
    SELECT json_build_object(
        'author_id', $1,
        'total_articles', (SELECT COUNT(*) FROM author_articles),
        'total_reads', rs.total_reads,
        'unique_readers', rs.unique_readers,
        'last_30_days_unique_readers', rs.last_30_days_unique_readers,
        'last_90_days_articles', rs.last_90_days_articles,
        'average_read_time', COALESCE(rs.average_read_time, 0),
        'completion_rate', COALESCE(rs.completion_rate, 0),
        'created_at', NOW()
    ) INTO result
    FROM reading_stats rs;
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

## 🧪 測試策略

### 單元測試
- ReadingTrackingService 追蹤邏輯測試
- EligibilityEvaluationService 評估算法測試
- 通知服務觸發條件測試

### 整合測試
- 完整的閱讀-評估-通知流程測試
- 數據庫 RPC 函數測試
- UI 組件互動測試

### 性能測試
- 大量閱讀記錄處理性能
- 每日批量評估效率
- 數據庫查詢優化

## 🚀 部署指南

### 數據庫遷移
1. 創建新的數據表
2. 添加必要的索引
3. 部署 RPC 函數
4. 設置 RLS 政策

### 應用部署
1. 更新 iOS 應用代碼
2. 測試所有功能
3. 監控系統性能
4. 收集用戶反饋

## 📈 監控和分析

### 關鍵指標
- 每日活躍閱讀用戶數
- 作者資格達成率
- 平均閱讀時長
- 通知打開率

### 監控面板
- 實時閱讀追蹤狀態
- 資格評估成功率
- 系統錯誤監控
- 性能指標追蹤

## 🔮 未來擴展

### 增強功能
- 更精確的滾動追蹤
- 多維度閱讀質量評估
- 機器學習預測模型
- 個性化通知策略

### 高級特性
- A/B 測試資格條件
- 動態調整評估週期
- 跨平台閱讀追蹤
- 社交媒體整合

---

## 🎯 結論

收益資格達成判斷系統為 Invest_V3 平台提供了一個公平、透明、可擴展的作者收益管理機制。通過四項核心條件的評估，確保了高品質內容的創作和公平的收益分配。

**系統特點**:
- ✅ 全自動評估機制
- ✅ 實時追蹤和通知
- ✅ 透明的進度顯示
- ✅ 可擴展的架構設計

**預期效果**:
- 提升內容品質
- 增加用戶參與度
- 建立健康的創作生態
- 實現可持續的平台發展

---

*文檔版本: v1.0*  
*最後更新: 2025年8月3日*  
*作者: Claude AI Assistant*